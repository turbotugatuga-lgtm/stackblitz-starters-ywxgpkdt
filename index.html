<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Airdrop Solana</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">ðŸš€ Airdrop Solana</h1>

    <!-- BotÃ£o conectar -->
    <button id="connectBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg">
      Conectar Carteira Phantom
    </button>
    <p id="walletAddress" class="mt-2 text-sm text-gray-700"></p>

    <!-- Selecionar token -->
    <div class="mt-6">
      <label class="block font-medium">Token:</label>
      <select id="tokenSelect" class="w-full border rounded p-2">
        <option>Conecte a carteira...</option>
      </select>
    </div>

    <!-- Quantidade -->
    <div class="mt-4">
      <label class="block font-medium">Quantidade a enviar:</label>
      <input id="amountInput" type="number" min="0" step="any"
        class="w-full border rounded p-2" placeholder="Ex: 10" />
    </div>

    <!-- Upload ou manual -->
    <div class="mt-4">
      <label class="block font-medium">DestinatÃ¡rios:</label>
      <textarea id="recipients" class="w-full border rounded p-2"
        rows="3" placeholder="Cole endereÃ§os separados por linha"></textarea>
      <input id="fileInput" type="file" accept=".txt" class="mt-2" />
    </div>

    <!-- Custos -->
    <div class="mt-4 p-3 border rounded bg-white">
      <p class="text-sm text-gray-700">ðŸ’° Taxa fixa: <b>0.00005 SOL</b> por carteira</p>
      <p id="costInfo" class="text-sm text-gray-700 mt-1">Total: -</p>
    </div>

    <!-- BotÃ£o enviar -->
    <button id="sendBtn" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg">
      Enviar Tokens
    </button>

    <!-- Logs -->
    <pre id="log" class="mt-6 bg-black text-green-400 p-3 rounded h-60 overflow-y-auto text-xs"></pre>
  </div>

  <!-- DependÃªncias Solana -->
  <script type="module">
    import {
      Connection,
      clusterApiUrl,
      PublicKey,
      Transaction,
      SystemProgram
    } from "https://esm.sh/@solana/web3.js";

    import * as splToken from "https://esm.sh/@solana/spl-token";

    let wallet = null;
    const connection = new Connection(clusterApiUrl("mainnet-beta"), "confirmed");
    const feeWallet = new PublicKey("9Sexip38yhfeZD2EBDQkVRicZSY6eSK3cXxgDkgFVf8b"); // sua taxa

    function log(msg) {
      const el = document.getElementById("log");
      el.textContent += msg + "\\n";
      el.scrollTop = el.scrollHeight;
    }

    // conectar Phantom
    document.getElementById("connectBtn").onclick = async () => {
      try {
        const provider = window.solana;
        if (!provider?.isPhantom) {
          alert("Instale a Phantom Wallet");
          return;
        }
        const resp = await provider.connect();
        wallet = new PublicKey(resp.publicKey.toString());
        document.getElementById("walletAddress").textContent = "Carteira: " + wallet.toBase58();
        log("Conectado: " + wallet.toBase58());
        await loadTokens();
      } catch (e) {
        log("Erro ao conectar: " + e.message);
      }
    };

    // carregar tokens
    async function loadTokens() {
      document.getElementById("tokenSelect").innerHTML = "";

      // saldo SOL
      const balance = await connection.getBalance(wallet);
      const solOption = document.createElement("option");
      solOption.value = "SOL";
      solOption.textContent = `SOL â€” saldo: ${(balance / 1e9).toFixed(4)}`;
      document.getElementById("tokenSelect").appendChild(solOption);

      // tokens SPL
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(wallet, {
        programId: splToken.TOKEN_PROGRAM_ID
      });

      tokenAccounts.value.forEach(acc => {
        const info = acc.account.data.parsed.info;
        const mint = info.mint;
        const amount = info.tokenAmount.uiAmount;
        if (amount > 0) {
          const option = document.createElement("option");
          option.value = mint;
          option.textContent = `${mint} â€” saldo: ${amount}`;
          document.getElementById("tokenSelect").appendChild(option);
        }
      });
    }

    // calcular custo
    function updateCost() {
      const recipients = document.getElementById("recipients").value.trim().split(/\\n+/).filter(x => x);
      const totalFee = recipients.length * 0.00005;
      document.getElementById("costInfo").textContent =
        `Carteiras: ${recipients.length} | Taxa fixa: ${totalFee.toFixed(6)} SOL + gas da rede`;
    }
    document.getElementById("recipients").addEventListener("input", updateCost);
    document.getElementById("fileInput").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      const text = await file.text();
      document.getElementById("recipients").value = text;
      updateCost();
    });

    // enviar
    document.getElementById("sendBtn").onclick = async () => {
      try {
        if (!wallet) {
          alert("Conecte a carteira primeiro!");
          return;
        }
        const recipients = document.getElementById("recipients").value.trim().split(/\\n+/).filter(x => x);
        const amount = parseFloat(document.getElementById("amountInput").value);
        const token = document.getElementById("tokenSelect").value;

        if (!recipients.length || !amount) {
          alert("Preencha os destinatÃ¡rios e quantidade");
          return;
        }

        for (let addr of recipients) {
          const to = new PublicKey(addr);

          if (token === "SOL") {
            // enviar SOL
            let tx = new Transaction().add(
              SystemProgram.transfer({
                fromPubkey: wallet,
                toPubkey: to,
                lamports: amount * 1e9
              }),
              SystemProgram.transfer({
                fromPubkey: wallet,
                toPubkey: feeWallet,
                lamports: 0.00005 * 1e9
              })
            );
            let { signature } = await window.solana.signAndSendTransaction(tx);
            log("Enviado SOL para " + addr + " tx: " + signature);

          } else {
            // enviar token SPL
            const mint = new PublicKey(token);
            const fromTokenAcc = await splToken.getAssociatedTokenAddress(mint, wallet);
            const toTokenAcc = await splToken.getAssociatedTokenAddress(mint, to);

            const ix = splToken.createTransferInstruction(
              fromTokenAcc,
              toTokenAcc,
              wallet,
              amount * (10 ** 6) // assumindo decimais=6
            );

            let tx = new Transaction().add(ix,
              SystemProgram.transfer({
                fromPubkey: wallet,
                toPubkey: feeWallet,
                lamports: 0.00005 * 1e9
              })
            );

            let { signature } = await window.solana.signAndSendTransaction(tx);
            log("Enviado SPL " + token + " para " + addr + " tx: " + signature);
          }
        }
      } catch (e) {
        log("Erro envio: " + e.message);
      }
    };
  </script>
</body>
</html>
