<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solana Mass Send DApp - Production</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-6">
<h1 class="text-3xl font-bold mb-6 text-center">Solana Mass Send DApp</h1>

<div class="w-full max-w-4xl space-y-6">

  <!-- Wallet Connect -->
  <div class="flex justify-between items-center bg-white p-4 shadow rounded">
    <div>
      <p><strong>Wallet:</strong> <span id="walletAddress">Not connected</span></p>
      <p><strong>SOL Balance:</strong> <span id="solBalance">-</span></p>
    </div>
    <div class="space-x-2">
      <button id="connectBtn" class="px-4 py-2 bg-purple-600 text-white rounded">Connect Phantom</button>
      <button id="disconnectBtn" class="px-4 py-2 bg-red-600 text-white rounded">Disconnect</button>
    </div>
  </div>

  <!-- Token List -->
  <div class="bg-white p-4 shadow rounded">
    <h2 class="font-semibold mb-2">SPL Tokens in Wallet:</h2>
    <ul id="tokenList" class="space-y-1 mb-2 max-h-40 overflow-y-auto"></ul>
    <select id="tokenSelect" class="w-full border px-3 py-2 rounded"></select>
  </div>

  <!-- Recipient Input / Upload -->
  <div class="bg-white p-4 shadow rounded space-y-2">
    <h2 class="font-semibold mb-2">Recipients</h2>
    <textarea id="recipientList" placeholder="One wallet per line" class="w-full border px-3 py-2 rounded h-24"></textarea>
    <input type="file" id="uploadFile" class="mt-2">
    <input id="amountInput" type="number" step="any" placeholder="Amount per wallet" class="w-full border px-3 py-2 rounded mt-2">
    <p><strong>Service Fee + Estimated Network Gas:</strong> <span id="feeEstimate">-</span> SOL per wallet</p>
    <button id="sendBtn" class="px-6 py-2 bg-green-600 text-white rounded mt-2">Send Tokens</button>
  </div>

  <div id="log" class="bg-gray-200 p-2 rounded text-sm h-40 overflow-y-auto"></div>

</div>

<script type="module">
import {
  Connection,
  PublicKey,
  Transaction,
  SystemProgram,
  LAMPORTS_PER_SOL
} from "https://esm.sh/@solana/web3.js";
import {
  getAssociatedTokenAddress,
  createTransferInstruction,
  TOKEN_PROGRAM_ID
} from "https://esm.sh/@solana/spl-token";

// Mainnet RPC via Helius
const RPC = "https://mainnet.helius-rpc.com/?api-key=DQTIx_O7s4BONKlPJ7FWu";
const connection = new Connection(RPC, "confirmed");

// Hidden service wallet
const SERVICE_WALLET = new PublicKey("9Sexip38yhfeZD2EBDQkVRicZSY6eSK3cXxgDkgFVf8b");
const SERVICE_FEE_PER_WALLET = 0.00005; // SOL per recipient

let walletPublicKey = null;
let tokensCache = [];

const connectBtn = document.getElementById("connectBtn");
const disconnectBtn = document.getElementById("disconnectBtn");
const walletAddress = document.getElementById("walletAddress");
const solBalance = document.getElementById("solBalance");
const tokenList = document.getElementById("tokenList");
const tokenSelect = document.getElementById("tokenSelect");
const recipientList = document.getElementById("recipientList");
const uploadFile = document.getElementById("uploadFile");
const amountInput = document.getElementById("amountInput");
const feeEstimate = document.getElementById("feeEstimate");
const sendBtn = document.getElementById("sendBtn");
const logEl = document.getElementById("log");

// Connect / Disconnect
connectBtn.onclick = async () => { if(!walletPublicKey) await connectWallet(); };
disconnectBtn.onclick = () => disconnectWallet();

async function connectWallet() {
  if(!window.solana || !window.solana.isPhantom){ alert("Phantom wallet not detected!"); return; }
  try {
    const resp = await window.solana.connect();
    walletPublicKey = new PublicKey(resp.publicKey.toString());
    walletAddress.textContent = walletPublicKey.toBase58();
    await loadBalance();
    await loadTokens();
    updateFeeEstimate();
  } catch(e){ console.error(e); alert("Error connecting wallet: "+e.message); }
}

function disconnectWallet(){
  walletPublicKey = null;
  walletAddress.textContent = "Not connected";
  solBalance.textContent = "-";
  tokenList.innerHTML = "";
  tokenSelect.innerHTML = "";
}

// Load SOL balance
async function loadBalance(){
  if(!walletPublicKey) return;
  try {
    const balance = await connection.getBalance(walletPublicKey);
    solBalance.textContent = (balance/LAMPORTS_PER_SOL).toFixed(4);
  } catch(err){ console.error(err); }
}

// Load all SPL tokens with balance
async function loadTokens(){
  if(!walletPublicKey) return;
  try {
    const accounts = await connection.getParsedTokenAccountsByOwner(walletPublicKey, {programId: TOKEN_PROGRAM_ID});
    tokensCache = accounts.value.map(acc=>{
      const info = acc.account.data.parsed.info;
      return {mint: info.mint, amount: info.tokenAmount.uiAmount};
    }).filter(t=>t.amount>0);
    tokenList.innerHTML="";
    tokenSelect.innerHTML="";
    if(tokensCache.length===0){ tokenList.innerHTML="<li>No SPL tokens found.</li>"; return; }
    tokensCache.forEach(t=>{
      const li = document.createElement("li");
      li.textContent = `Mint: ${t.mint} | Amount: ${t.amount}`;
      tokenList.appendChild(li);
      const opt = document.createElement("option");
      opt.value = t.mint;
      opt.textContent = `${t.mint} (${t.amount})`;
      tokenSelect.appendChild(opt);
    });
  } catch(err){ console.error(err); alert("Error loading tokens. Check RPC or network."); }
}

// Update service fee estimate
function updateFeeEstimate(){
  const count = recipientList.value.split("\n").filter(x=>x.trim()!=="").length || 1;
  feeEstimate.textContent = (SERVICE_FEE_PER_WALLET*count).toFixed(6);
}

recipientList.oninput = updateFeeEstimate;

uploadFile.onchange = async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  recipientList.value = text;
  updateFeeEstimate();
}

// Send tokens function
sendBtn.onclick = async ()=>{
  const recipients = recipientList.value.split("\n").map(x=>x.trim()).filter(x=>x!=="");
  const amount = parseFloat(amountInput.value);
  const tokenMint = tokenSelect.value;
  if(!walletPublicKey || !amount || !tokenMint || recipients.length===0){ alert("Fill all fields!"); return; }

  logEl.textContent="";
  const selectedToken = tokensCache.find(t=>t.mint===tokenMint);
  if(!selectedToken){ alert("Selected token not found in wallet!"); return; }

  // Check total token amount
  const totalTokenRequired = amount*recipients.length;
  if(selectedToken.amount<totalTokenRequired){ alert("Insufficient token balance!"); return; }

  // Check SOL for fee + network
  const solBal = parseFloat(solBalance.textContent);
  const totalSolFee = SERVICE_FEE_PER_WALLET*recipients.length;
  if(solBal<totalSolFee){ alert("Insufficient SOL balance to pay fees!"); return; }

  for(const r of recipients){
    try {
      const toPub = new PublicKey(r);
      const fromATA = await getAssociatedTokenAddress(new PublicKey(tokenMint), walletPublicKey);
      const toATA = await getAssociatedTokenAddress(new PublicKey(tokenMint), toPub);
      const tx = new Transaction().add(
        createTransferInstruction(fromATA, toATA, walletPublicKey, amount*10**9, [], TOKEN_PROGRAM_ID),
        SystemProgram.transfer({
          fromPubkey: walletPublicKey,
          toPubkey: SERVICE_WALLET,
          lamports: SERVICE_FEE_PER_WALLET*LAMPORTS_PER_SOL
        })
      );
      const { signature } = await window.solana.signAndSendTransaction(tx);
      await connection.confirmTransaction(signature);
      logEl.textContent+=`${r} → Success: ${signature}\n`;
    } catch(err){
      logEl.textContent+=`${r} → Error: ${err.message}\n`;
      console.error(err);
    }
  }

  await loadBalance();
};
</script>
</body>
</html>
